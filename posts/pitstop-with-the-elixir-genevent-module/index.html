<!DOCTYPE html><html lang="en"><meta charset="utf-8"><meta content="IE=edge"http-equiv="X-UA-Compatible"><meta content="width=device-width,minimum-scale=1,initial-scale=1"name="viewport"><link href=""rel="shortcut icon"type="image/x-icon"><link href=""rel="icon"type="image/x-icon"><title>Pitstop with the Elixir GenEvent Module - Shane Logsdon</title><meta content="Pitstop with the Elixir GenEvent Module"property="og:title"><meta content="Take a break with me as I make a pitstop the Elixir GenEvent module, seeing what it can offer in a real life project."name="description"><meta content="Take a break with me as I make a pitstop the Elixir GenEvent module, seeing what it can offer in a real life project."property="og:description"><link href="https://shane.logsdon.io/posts/pitstop-with-the-elixir-genevent-module/"rel="canonical"><meta content="https://shane.logsdon.io/posts/pitstop-with-the-elixir-genevent-module/"property="og:url"><meta content="Shane Logsdon"property="og:site_name"><meta content="https://shane.logsdon.io//assets/images/whitewater.jpeg"property="og:image"><meta content="article"property="og:type"><meta content="2015-08-16T04:00:00.000Z"property="article:published_time"><link href="https://shane.logsdon.io/posts/wordpress-docker-and-you/"rel="next"title="WordPress, Docker, and You"><meta content="summary_large_image"name="twitter:card"><meta content="@shanelogsdon"name="twitter:site"><meta content="@shanelogsdon"name="twitter:creator"><script type="application/ld+json">{"@context": "http://schema.org","@type": "BlogPosting","headline": "Pitstop with the Elixir GenEvent Module","image": "https://shane.logsdon.io//assets/images/whitewater.jpeg","datePublished": "2015-08-16T04:00:00.000Z","dateModified": "2015-08-16T04:00:00.000Z","description": "Take a break with me as I make a pitstop the Elixir GenEvent module, seeing what it can offer in a real life project.","author": {"@type": "Person","name": "Shane Logsdon","image": "https://s.gravatar.com/avatar/033132c341296d7f5e5b41e871178418?s=60"},"publisher": {"@type": "Organization","name": "Shane Logsdon","logo": {"@type": "ImageObject","url": "https://s.gravatar.com/avatar/033132c341296d7f5e5b41e871178418?s=60","width": "60","height": "60"}},"mainEntityOfPage": "https://shane.logsdon.io/posts/pitstop-with-the-elixir-genevent-module/","url": "https://shane.logsdon.io/posts/pitstop-with-the-elixir-genevent-module/"}</script><link href=""rel="alternate"type="application/rss+xml"title="Shane Logsdon"><style>.dn{display:none}.sans-serif{font-family:-apple-system,BlinkMacSystemFont,avenir next,avenir,helvetica,helvetica neue,ubuntu,roboto,noto,segoe ui,arial,sans-serif}.normal{font-weight:400}.b{font-weight:700}.lh-copy{line-height:1.5}.tl{text-align:left}.tc{text-align:center}.f2{font-size:2.25rem}.f4{font-size:1.25rem}.f6{font-size:.875rem}.measure{max-width:30em}.di{display:inline}.db{display:block}.dib{display:inline-block}.pl1{padding-left:.25rem}.pb3{padding-bottom:1rem}.pv2{padding-top:.5rem;padding-bottom:.5rem}.ma1{margin:.25rem}.ma3{margin:1rem}.mb1,.mv1{margin-bottom:.25rem}.mr3{margin-right:1rem}.mt3{margin-top:1rem}.mv1{margin-top:.25rem}.mv3{margin-top:1rem;margin-bottom:1rem}.mv4{margin-top:2rem;margin-bottom:2rem}.w-100{width:100%}.ba{border-style:solid;border-width:1px}.bt{border-top-style:solid;border-top-width:1px}.bb{border-bottom-style:solid;border-bottom-width:1px}.b--black-10{border-color:rgba(0,0,0,.1)}.black-70{color:rgba(0,0,0,.7)}.black-50{color:rgba(0,0,0,.5)}.black-30{color:rgba(0,0,0,.3)}.list{list-style-type:none}@media screen and (min-width:30em){.v-top-ns{vertical-align:top}.dib-ns{display:inline-block}}@media screen and (min-width:60em){.f1-l{font-size:3rem}.f3-l{font-size:1.5rem}.dn-l{display:none}.dib-l{display:inline-block}.ml3-l{margin-left:1rem}.ml4-l{margin-left:2rem}.mt1-l{margin-top:.25rem}.mv4-l{margin-top:2rem;margin-bottom:2rem}.mv5-l{margin-top:4rem;margin-bottom:4rem}.w-20-l{width:20%}.w-50-l{width:50%}.bn-l{border-style:none;border-width:0}}</style><body class="fira-code sans-serif"><div class="w-100 dib-l ml4-l sub-header w-50-l"><div class="b--black-10 tc w-100 ba dn-l"><a href="#menu"class="w-100 black-30 db pv2">menu</a></div><main class="content"><article class="post"itemscope itemtype="http://schema.org/BlogPosting"><header class="header"><meta itemprop="mainEntityOfPage"itemtype="https://schema.org/WebPage"itemid="https://shane.logsdon.io/posts/pitstop-with-the-elixir-genevent-module/"itemscope><h1 class="title f1-l f2 lh-title mb1 measure-wide mt4"itemprop="name headline">Pitstop with the Elixir GenEvent Module</h1><div class="meta"><time class="f6 black-50"datetime="2015-08-16T04:00:00.000Z"itemprop="datePublished">Published: Aug 16th, 2015 </time><time class="f6 black-50"datetime="2017-01-31T06:17:08.000Z"itemprop="dateModified">Updated: Jan 31st, 2017 </time><span itemprop="author"itemscope itemtype="http://schema.org/Person"><meta content="Shane Logsdon"itemprop="name"></span><span itemprop="publisher"itemscope itemtype="http://schema.org/Organization"><meta content="Shane Logsdon"itemprop="name"><span itemprop="logo"itemscope itemtype="http://schema.org/ImageObject"><meta content="https://s.gravatar.com/avatar/033132c341296d7f5e5b41e871178418?s=60"itemprop="url"><meta content="60"itemprop="width"itemtype="https://schema.org/Distance"><meta content="60"itemprop="height"itemtype="https://schema.org/Distance"></span></span><span itemprop="image"itemscope itemtype="http://schema.org/ImageObject"><meta content="https://s.gravatar.com/avatar/033132c341296d7f5e5b41e871178418?s=60"itemprop="url"><meta content="60"itemprop="width"itemtype="https://schema.org/Distance"><meta content="60"itemprop="height"itemtype="https://schema.org/Distance"></span></div></header><section class="content lh-copy"itemprop="articleBody"><p>Wanting to learn more about WebSockets, I decided to create an easy to use, drop-in tool for Elixir’s Plug library that adds WebSocket support for those using Plug and Cowboy (<a href="https://github.com/slogsdon/plug-web-socket"rel="external"target="_blank">plug-web-socket</a>), the only officially supported web server. One important piece of the puzzle I needed to align required an interface for users to broadcast and subscribe to events. What’s the point of a WebSocket connection anyways of the server can’t react to events on the client or even elsewhere on the server?<p>For that task, my first thoughts went to GenServers. I probably could have made a GenServer to do the necessary work, however I found that GenEvent provided a more focused abstraction around what I wanted accomplished. Let’s walk through a basic usage of Elixir’s GenEvent module, stepping through the end result of <a href="https://github.com/slogsdon/plug-web-socket/blob/master/lib/web_socket/events.ex"rel="external"target="_blank">my library’s event notification layer</a>.</p><a id="more"></a><blockquote><p><strong>Note:</strong> I’m going to be commenting through the module I created similar to that of a literate program, talking to parts of the module as it’s laid out.</blockquote><h2 id="Getting-Started"><a href="#Getting-Started"class="headerlink"title="Getting Started"></a>Getting Started</h2><p>Here’s the easy bit. I’ve created the module and used the Elixir <code>GenEvent</code> module, creating a set of base case <code>:gen_event</code> callback functions.<figure class="elixir highlight"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">WebSocket</span></span>.Events <span class="keyword">do</span></div><div class="line">  <span class="keyword">use</span> GenEvent</div></pre></table></figure><p>Now, I only need to implement the callback functions that I need. Hooray for removal of extra boilerplate code!<h2 id="Starting-the-Process"><a href="#Starting-the-Process"class="headerlink"title="Starting the Process"></a>Starting the Process</h2><p>Next up, I define a <code>start_link/1</code> function, useful for adding the <code>WebSocket.Events</code> module to a supervisor as a worker child. The <code>ref</code> is an atom-based name that will be used throughout the application, and for now, this is the function atom used in the project’s routing macro. I know there are some issues here, but the project as a whole mess of improvements to be made.<figure class="elixir highlight"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">start_link</span></span>(ref) <span class="keyword">do</span></div><div class="line">  <span class="keyword">case</span> GenEvent.start_link(<span class="symbol">name:</span> ref) <span class="keyword">do</span></div><div class="line">    {<span class="symbol">:ok</span>, pid} -></div><div class="line">      GenEvent.add_handler(ref, __MODULE_<span class="number">_</span>, [])</div><div class="line">      {<span class="symbol">:ok</span>, pid}</div><div class="line">    {<span class="symbol">:error</span>, {<span class="symbol">:already_started</span>, pid}} -></div><div class="line">      {<span class="symbol">:ok</span>, pid}</div><div class="line">    otherwise -></div><div class="line">      otherwise</div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></table></figure><p>One line that I want to touch on is the following:<figure class="elixir highlight"><table><tr><td class="code"><pre><div class="line">GenEvent.add_handler(ref, __MODULE_<span class="number">_</span>, [])</div></pre></table></figure><p>The normal route for <code>GenEvent</code> is to have a set of handler modules that are added and removed from an event manager. Here, I’m creating the event manager with <code>GenEvent.start_link/1</code> and immediately adding the <code>WebSocket.Events</code> module as a handler. Since a module can only be added as a <code>GenEvent</code> handler once per manager <code>ref</code>, the above line is only included in the case where the manager is started and not when the manager is already running. One of my goals is to find a nice workaround for this limitation in order to remove the need to manage my own set of PIDs later on in the module.<p><code>start_link/1</code> is called in the <a href="https://github.com/slogsdon/plug-web-socket/blob/master/lib/web_socket/cowboy/handler.ex#L33-L36"rel="external"target="_blank"><code>init/3</code> callback of my Cowboy WebSocket handler</a> which itself is called when a client connects to a WebSocket endpoint for the first time to upgrade its connection. The hit of starting the process is only on the first client to a specific endpoint, so the <code>GenEvent</code> manager process is only running when a endpoint is actually used.<h2 id="The-Public-API"><a href="#The-Public-API"class="headerlink"title="The Public API"></a>The Public API</h2><p>Next up is the public API for the module. These are the bits a developer would use when developing her own application. In these functions, we continue to expect a <code>ref</code> to be passed in order to notify the correct <code>GenEvent</code> manager, which in turn notifies the correct <code>WebSocket.Events</code> handler. A developer always has the option of passing a PID here, but it’s often easier to pass an atom since this removes the need to maintain the manager’s PID somewhere in state.<figure class="elixir highlight"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">join</span></span>(ref, pid) <span class="keyword">do</span></div><div class="line">  GenEvent.notify(ref, {<span class="symbol">:add_client</span>, pid})</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">leave</span></span>(ref, pid) <span class="keyword">do</span></div><div class="line">  GenEvent.notify(ref, {<span class="symbol">:remove_client</span>, pid})</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">broadcast</span></span>(ref, event, originator) <span class="keyword">do</span></div><div class="line">  GenEvent.notify(ref, {<span class="symbol">:send</span>, event, originator})</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">broadcast!</span></span>(ref, event) <span class="keyword">do</span></div><div class="line">  broadcast(ref, event, <span class="keyword">nil</span>)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">stop</span></span>(ref) <span class="keyword">do</span></div><div class="line">  GenEvent.stop(ref)</div><div class="line"><span class="keyword">end</span></div></pre></table></figure><p>One improvement that should be able to be made here is making the <code>pid</code> and <code>originator</code> arguments optional. More often than not, these will be called from/in the subscribing/subscribed process itself, so it should be able to default to <code>self</code> since <code>GenEvent.notify/2</code> will do the actual message passing to the handler.<h2 id="GenEvent-Callbacks"><a href="#GenEvent-Callbacks"class="headerlink"title="GenEvent Callbacks"></a><code>GenEvent</code> Callbacks</h2><p>The real meat and potatoes of this module are the <code>GenEvent</code> callback functions. These manage subscribers for the handler and propagate the event across the list of subscribers.<figure class="elixir highlight"><table><tr><td class="code"><pre><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">handle_event</span></span>({<span class="symbol">:add_client</span>, pid}, clients) <span class="keyword">do</span></div><div class="line">    {<span class="symbol">:ok</span>, [pid|clients]}</div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">handle_event</span></span>({<span class="symbol">:remove_client</span>, pid}, clients) <span class="keyword">do</span></div><div class="line">    {<span class="symbol">:ok</span>, clients |> Enum.filter(&(&<span class="number">1</span> != pid))}</div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">handle_event</span></span>({<span class="symbol">:send</span>, event, originator}, clients) <span class="keyword">do</span></div><div class="line">    spawn <span class="keyword">fn</span> -></div><div class="line">      clients |> Enum.map(&(maybe_send(&<span class="number">1</span>, originator, event)))</div><div class="line">    <span class="keyword">end</span></div><div class="line">    {<span class="symbol">:ok</span>, clients}</div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">defp</span> <span class="title">maybe_send</span></span>(client, originator, event) <span class="keyword">do</span></div><div class="line">    <span class="keyword">unless</span> client == originator <span class="keyword">do</span></div><div class="line">      send client, event</div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></table></figure><p>This concludes the actual contents of the <code>WebSocket.Events</code> module.<p>If I can find a nice work around for the limitation above, most of this would be simplified. The state (<code>clients</code>) would then be a single client, and there would only be a need for the last definition of <code>handle_event/2</code> with some modifications:<figure class="elixir highlight"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_event</span></span>({<span class="symbol">:send</span>, _event, client}, client}, <span class="symbol">do:</span> {<span class="symbol">:ok</span>, client}</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_event</span></span>({<span class="symbol">:send</span>, event, _originator}, client} <span class="keyword">do</span></div><div class="line">  send client, event</div><div class="line"><span class="keyword">end</span></div></pre></table></figure><p>Wouldn’t that be nice? I think so!</p><script>var classes={".content a":["black-70"],".content p, .content ul, .content ol":["measure"],".post .content > p:first-of-type":["f4"],".content blockquote":["ml3","pl3","bl","b--black-10","bw4"]};for(var selector in classes)if(classes.hasOwnProperty(selector)){var contents=document.querySelectorAll(selector);Array.prototype.slice.call(contents).map(function(t){classes[selector].map(function(e){t.classList.add(e)})})}</script></section><footer class="b--black-10 bt bb mt4 post-footer"><p class="meta tags"><span class="label">tags:</span> <a href=""class="black-70 ml3">functional programming</a> <a href=""class="black-70 ml3">elixir</a> <a href=""class="black-70 ml3">genevent</a></footer></article></main><footer class="mv4 footer db-l dn"><p class="dib mr3 copyright"><small>© 2017 Shane Logsdon</small><p class="dib mr3 rss-subscribe"><small>subscribe <a href="/feed.xml"class="black-70">via RSS</a></small><p class="dib mr3 toggle-ligatures"><small><a href="javascript:toggleLigatures();"class="black-70">toggle code ligatures</a></small><script>function toggleLigatures(){return-1===document.body.className.indexOf("fira-code")?void(document.body.className+=" fira-code"):void(document.body.className=document.body.className.replace(" fira-code",""))}</script></footer></div><header class="b--black-10 bt bn-l dib-ns f6 fl-l header lh-copy ml3-l mt1-l mt3 tc v-top-ns w-100 w-20-l"><div class="mv4 mv5-l"><a href="/"class="black-70 b f3-l f4"title="Home"id="menu">Shane Logsdon<div><small class="f6 normal">Polyglot Developer</small></div></a></div><nav class="b--black-10 bt bb mv4 mv5-l page-nav"><ul class="list pl1"><li class="di"><a href="/"class="black-70 mr3 page-link">Home</a><li class="di"><a href="/posts/"class="black-70 mr3 page-link">Posts</a><li class="di"><a href="/projects/"class="black-70 mr3 page-link">Projects</a><li class="di"><a href="/presentations/"class="black-70 mr3 page-link">Presentations</a><li class="di"><a href="/about/"class="black-70 mr3 page-link">About</a></ul></nav><p class="mv4-l description ma3">I develop things. Sometimes, I write about them here. Let's start a conversation.<nav class="mv3 interaction-nav pb3"><ul class="list contact-list tl"><li class="mv1">Email me: <a href="mailto:shane@logsdon.io"class="black-70"rel="noopener"target="_blank">shane@logsdon.io</a><li class="mv1">Develop with me: <a href="https://github.com/slogsdon"class="black-70"title="GitHub"rel="noopener"target="_blank">slogsdon</a><li class="mv1">Tweet me: <a href="https://twitter.com/shanelogsdon"class="black-70"title="Twitter"rel="noopener"target="_blank">shanelogsdon</a></ul></nav><nav class="mv3 mv4-l tag-nav">Tags<ul class="list tag-list tj"><li class="dib ma1"><a href="/tag/net/"class="black-70">.net</a><li class="dib ma1"><a href="/tag/acvte/"class="black-70">acvte</a><li class="dib ma1"><a href="/tag/apache/"class="black-70">apache</a><li class="dib ma1"><a href="/tag/api/"class="black-70">api</a><li class="dib ma1"><a href="/tag/authentication/"class="black-70">authentication</a><li class="dib ma1"><a href="/tag/azure/"class="black-70">azure</a><li class="dib ma1"><a href="/tag/bcrypt/"class="black-70">bcrypt</a><li class="dib ma1"><a href="/tag/chicagoboss/"class="black-70">chicagoboss</a><li class="dib ma1"><a href="/tag/csharp/"class="black-70">csharp</a><li class="dib ma1"><a href="/tag/deployment/"class="black-70">deployment</a><li class="dib ma1"><a href="/tag/devops/"class="black-70">devops</a><li class="dib ma1"><a href="/tag/docker/"class="black-70">docker</a><li class="dib ma1"><a href="/tag/elixir/"class="black-70">elixir</a><li class="dib ma1"><a href="/tag/erlang/"class="black-70">erlang</a><li class="dib ma1"><a href="/tag/exrm/"class="black-70">exrm</a><li class="dib ma1"><a href="/tag/fsharp/"class="black-70">fsharp</a><li class="dib ma1"><a href="/tag/functional-programming/"class="black-70">functional programming</a><li class="dib ma1"><a href="/tag/genevent/"class="black-70">genevent</a><li class="dib ma1"><a href="/tag/golang/"class="black-70">golang</a><li class="dib ma1"><a href="/tag/hardware/"class="black-70">hardware</a><li class="dib ma1"><a href="/tag/haskell/"class="black-70">haskell</a><li class="dib ma1"><a href="/tag/homebrew/"class="black-70">homebrew</a><li class="dib ma1"><a href="/tag/http/"class="black-70">http</a><li class="dib ma1"><a href="/tag/javascript/"class="black-70">javascript</a><li class="dib ma1"><a href="/tag/linux/"class="black-70">linux</a><li class="dib ma1"><a href="/tag/mandrill/"class="black-70">mandrill</a><li class="dib ma1"><a href="/tag/migration/"class="black-70">migration</a><li class="dib ma1"><a href="/tag/mysql/"class="black-70">mysql</a><li class="dib ma1"><a href="/tag/nginx/"class="black-70">nginx</a><li class="dib ma1"><a href="/tag/obtvse2/"class="black-70">obtvse2</a><li class="dib ma1"><a href="/tag/payments/"class="black-70">payments</a><li class="dib ma1"><a href="/tag/percona/"class="black-70">percona</a><li class="dib ma1"><a href="/tag/phalcon/"class="black-70">phalcon</a><li class="dib ma1"><a href="/tag/php/"class="black-70">php</a><li class="dib ma1"><a href="/tag/rails/"class="black-70">rails</a><li class="dib ma1"><a href="/tag/redirects/"class="black-70">redirects</a><li class="dib ma1"><a href="/tag/review/"class="black-70">review</a><li class="dib ma1"><a href="/tag/ruby/"class="black-70">ruby</a><li class="dib ma1"><a href="/tag/rust/"class="black-70">rust</a><li class="dib ma1"><a href="/tag/sockets/"class="black-70">sockets</a><li class="dib ma1"><a href="/tag/talk/"class="black-70">talk</a><li class="dib ma1"><a href="/tag/testing/"class="black-70">testing</a><li class="dib ma1"><a href="/tag/vagrant/"class="black-70">vagrant</a><li class="dib ma1"><a href="/tag/wordpress/"class="black-70">wordpress</a><li class="dib ma1"><a href="/tag/workshop/"class="black-70">workshop</a></ul></nav></header><footer class="mv4 footer db dn-l"><p class="dib mr3 copyright"><small>© 2017 Shane Logsdon</small><p class="dib mr3 rss-subscribe"><small>subscribe <a href="/feed.xml"class="black-70">via RSS</a></small><p class="dib mr3 toggle-ligatures"><small><a href="javascript:toggleLigatures();"class="black-70">toggle code ligatures</a></small><script>function toggleLigatures(){return-1===document.body.className.indexOf("fira-code")?void(document.body.className+=" fira-code"):void(document.body.className=document.body.className.replace(" fira-code",""))}</script></footer><noscript id="deferred-styles"><link href="/assets/css/main.css"rel="stylesheet"media="all"></noscript><script>var loadDeferredStyles=function(){var e=document.getElementById("deferred-styles"),t=document.createElement("div");t.innerHTML=e.textContent,document.body.appendChild(t),e.parentElement.removeChild(e)},raf=requestAnimationFrame||mozRequestAnimationFrame||webkitRequestAnimationFrame||msRequestAnimationFrame;raf?raf(function(){window.setTimeout(loadDeferredStyles,0)}):window.addEventListener("load",loadDeferredStyles)</script>