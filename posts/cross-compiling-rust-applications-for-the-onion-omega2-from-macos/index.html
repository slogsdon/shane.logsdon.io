<!DOCTYPE html><html lang="en"><meta charset="utf-8"><meta content="IE=edge"http-equiv="X-UA-Compatible"><meta content="width=device-width,minimum-scale=1,initial-scale=1"name="viewport"><link href=""rel="shortcut icon"type="image/x-icon"><link href=""rel="icon"type="image/x-icon"><title>Cross-Compiling Rust Applications for the Onion Omega2 from MacOS - Shane Logsdon</title><meta content="Cross-Compiling Rust Applications for the Onion Omega2 from MacOS"property="og:title"><meta content="Onion's Omega2 SoC computers are a prime target for cross-compiling Rust applications, taking care to set up your environment just right for the Omega2's MIPS architecture."name="description"><meta content="Onion's Omega2 SoC computers are a prime target for cross-compiling Rust applications, taking care to set up your environment just right for the Omega2's MIPS architecture."property="og:description"><link href="https://shane.logsdon.io/posts/cross-compiling-rust-applications-for-the-onion-omega2-from-macos/"rel="canonical"><meta content="https://shane.logsdon.io/posts/cross-compiling-rust-applications-for-the-onion-omega2-from-macos/"property="og:url"><meta content="Shane Logsdon"property="og:site_name"><meta content=""property="og:image"><meta content="article"property="og:type"><meta content="2017-01-11T23:57:01.000Z"property="article:published_time"><link href="https://shane.logsdon.io/posts/exploring-fsharp-with-dotnet-core-and-kestrel/"rel="next"title="Exploring F# with .NET Core and Kestrel"><meta content="summary"name="twitter:card"><meta content="@shanelogsdon"name="twitter:site"><meta content="@shanelogsdon"name="twitter:creator"><script type="application/ld+json">{"@context": "http://schema.org","@type": "BlogPosting","headline": "Cross-Compiling Rust Applications for the Onion Omega2 from MacOS","image": "https://s.gravatar.com/avatar/033132c341296d7f5e5b41e871178418?s=60","datePublished": "2017-01-11T23:57:01.000Z","dateModified": "2017-01-11T23:57:01.000Z","description": "Onion&#39;s Omega2 SoC computers are a prime target for cross-compiling Rust applications, taking care to set up your environment just right for the Omega2&#39;s MIPS architecture.","author": {"@type": "Person","name": "Shane Logsdon","image": "https://s.gravatar.com/avatar/033132c341296d7f5e5b41e871178418?s=60"},"publisher": {"@type": "Organization","name": "Shane Logsdon","logo": {"@type": "ImageObject","url": "https://s.gravatar.com/avatar/033132c341296d7f5e5b41e871178418?s=60","width": "60","height": "60"}},"mainEntityOfPage": "https://shane.logsdon.io/posts/cross-compiling-rust-applications-for-the-onion-omega2-from-macos/","url": "https://shane.logsdon.io/posts/cross-compiling-rust-applications-for-the-onion-omega2-from-macos/"}</script><link href=""rel="alternate"type="application/rss+xml"title="Shane Logsdon"><style>.dn{display:none}.sans-serif{font-family:-apple-system,BlinkMacSystemFont,avenir next,avenir,helvetica,helvetica neue,ubuntu,roboto,noto,segoe ui,arial,sans-serif}.normal{font-weight:400}.b{font-weight:700}.lh-copy{line-height:1.5}.tl{text-align:left}.tc{text-align:center}.f2{font-size:2.25rem}.f4{font-size:1.25rem}.f6{font-size:.875rem}.measure{max-width:30em}.di{display:inline}.db{display:block}.dib{display:inline-block}.pl1{padding-left:.25rem}.pb3{padding-bottom:1rem}.pv2{padding-top:.5rem;padding-bottom:.5rem}.ma1{margin:.25rem}.ma3{margin:1rem}.mb1,.mv1{margin-bottom:.25rem}.mr3{margin-right:1rem}.mt3{margin-top:1rem}.mv1{margin-top:.25rem}.mv3{margin-top:1rem;margin-bottom:1rem}.mv4{margin-top:2rem;margin-bottom:2rem}.w-100{width:100%}.ba{border-style:solid;border-width:1px}.bt{border-top-style:solid;border-top-width:1px}.bb{border-bottom-style:solid;border-bottom-width:1px}.b--black-10{border-color:rgba(0,0,0,.1)}.black-70{color:rgba(0,0,0,.7)}.black-50{color:rgba(0,0,0,.5)}.black-30{color:rgba(0,0,0,.3)}.list{list-style-type:none}@media screen and (min-width:30em){.v-top-ns{vertical-align:top}.dib-ns{display:inline-block}}@media screen and (min-width:60em){.f1-l{font-size:3rem}.f3-l{font-size:1.5rem}.dn-l{display:none}.dib-l{display:inline-block}.ml3-l{margin-left:1rem}.ml4-l{margin-left:2rem}.mt1-l{margin-top:.25rem}.mv4-l{margin-top:2rem;margin-bottom:2rem}.mv5-l{margin-top:4rem;margin-bottom:4rem}.w-20-l{width:20%}.w-50-l{width:50%}.bn-l{border-style:none;border-width:0}}</style><body class="fira-code sans-serif"><div class="w-100 dib-l ml4-l sub-header w-50-l"><div class="b--black-10 tc w-100 ba dn-l"><a href="#menu"class="w-100 black-30 db pv2">menu</a></div><main class="content"><article class="post"itemscope itemtype="http://schema.org/BlogPosting"><header class="header"><meta itemprop="mainEntityOfPage"itemtype="https://schema.org/WebPage"itemid="https://shane.logsdon.io/posts/cross-compiling-rust-applications-for-the-onion-omega2-from-macos/"itemscope><h1 class="title f1-l f2 lh-title mb1 measure-wide mt4"itemprop="name headline">Cross-Compiling Rust Applications for the Onion Omega2 from MacOS</h1><div class="meta"><time class="f6 black-50"datetime="2017-01-11T23:57:01.000Z"itemprop="datePublished">Published: Jan 11th, 2017 </time><time class="f6 black-50"datetime="2017-01-31T06:17:08.000Z"itemprop="dateModified">Updated: Jan 31st, 2017 </time><span itemprop="author"itemscope itemtype="http://schema.org/Person"><meta content="Shane Logsdon"itemprop="name"></span><span itemprop="publisher"itemscope itemtype="http://schema.org/Organization"><meta content="Shane Logsdon"itemprop="name"><span itemprop="logo"itemscope itemtype="http://schema.org/ImageObject"><meta content="https://s.gravatar.com/avatar/033132c341296d7f5e5b41e871178418?s=60"itemprop="url"><meta content="60"itemprop="width"itemtype="https://schema.org/Distance"><meta content="60"itemprop="height"itemtype="https://schema.org/Distance"></span></span><span itemprop="image"itemscope itemtype="http://schema.org/ImageObject"><meta content="https://s.gravatar.com/avatar/033132c341296d7f5e5b41e871178418?s=60"itemprop="url"><meta content="60"itemprop="width"itemtype="https://schema.org/Distance"><meta content="60"itemprop="height"itemtype="https://schema.org/Distance"></span></div></header><section class="content lh-copy"itemprop="articleBody"><p>After recently receiving the shipment for my <a href="https://www.kickstarter.com/projects/onion/omega2-5-iot-computer-with-wi-fi-powered-by-linux/description"rel="external"target="_blank">Onion Omega2 Kickstarter</a> reward, I did as any other software developer might do: I started figuring out what it would take to get software running on it. Onion’s <a href="https://docs.onion.io/omega2-docs/"rel="external"target="_blank">Omega2 documentation</a> has information about installing and using Python, but while this is powerful and aids product adoption, limitations of developing directly on the device soon appear. Limited disk space, limited RAM, and limited CPU speeds will hinder development and builing of most compiled languages. To me, this sounds like a great opportunity to learn how to cross-compile applications, allowing for development and building of applications in my normal development environment. I’ve been tinkering with Rust recently, so it became my language of choice for this exercise.<p><strong>tl;dr</strong> It works.<p><blockquote class="twitter-tweet"data-conversation="none"data-lang="en"><br><p dir="ltr"lang="en"><br>running <a href="https://t.co/3I3pE2WS4W"rel="external"target="_blank">https://t.co/3I3pE2WS4W</a><br>and <a href="https://twitter.com/rustlang"rel="external"target="_blank">@rustlang</a> on an<br><a href="https://twitter.com/OnionIoT"rel="external"target="_blank">@OnionIoT</a> Omega 2+, cross-compiled from MacOS<br><a href="https://t.co/SdiKSNPZMZ"rel="external"target="_blank">pic.twitter.com/SdiKSNPZMZ</a><br></p><br>— Shane Logsdon (@shanelogsdon)<br><a href="https://twitter.com/shanelogsdon/status/819204972290199553"rel="external"target="_blank">January 11, 2017</a><br></blockquote></p><script async charset="utf-8"src="//platform.twitter.com/widgets.js"></script><h2 id="Overview-of-steps-needed"><a href="#Overview-of-steps-needed"class="headerlink"title="Overview of steps needed"></a>Overview of steps needed</h2><p>Not having cross-compiled applications before, I did some research into what it takes to cross-compile:<ul><li>Know your target triple<li>Have your application code<li>Have a build toolchain from your target available on your host (build) system<li>Use the target toolchain to build you application</ul><h3 id="What’s-a-triple"><a href="#What’s-a-triple"class="headerlink"title="What’s a triple?"></a>What’s a triple?</h3><p>The target triple (or triplet) is an identifier that represents three pieces of information, architecture, vendor, and operating system, and will typically follow the form:<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&lt;architecture>-&lt;vendor>-&lt;operating-system></div></pre></table></figure><h3 id="What-is-going-to-be-built"><a href="#What-is-going-to-be-built"class="headerlink"title="What is going to be built?"></a>What is going to be built?</h3><p>I wanted to build something in Rust that was more than a simple “Hello World” application that wrote to the console, so I looked to <a href="https://rocket.rs"rel="external"target="_blank">Rocket</a> to build a simple web application server. Let’s take a look at the application code to see what we’re working with.<blockquote><p>Scaffold the project</blockquote><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cargo new --bin rocket_testing</div><div class="line">     Created binary (application) `rocket_testing` project</div><div class="line">$ cd rocket_testing</div><div class="line">$ tree</div><div class="line">.</div><div class="line">├── Cargo.toml</div><div class="line">└── src</div><div class="line">    └── main.rs</div><div class="line"></div><div class="line">1 directory, 2 files</div></pre></table></figure><blockquote><p>Add dependencies</blockquote><figure class="highlight toml"><table><tr><td class="code"><pre><div class="line"><span class="section">[package]</span></div><div class="line"><span class="attr">name</span> = <span class="string">"rocket_testing"</span></div><div class="line"><span class="attr">version</span> = <span class="string">"0.1.0"</span></div><div class="line"><span class="attr">authors</span> = [<span class="string">"Shane Logsdon &lt;shane@shanelogsdon.com>"</span>]</div><div class="line"><span class="section"></span></div><div class="line">[dependencies]</div><div class="line"><span class="attr">rocket</span> = <span class="string">"0.1.4"</span></div><div class="line"><span class="attr">rocket_codegen</span> = <span class="string">"0.1.4"</span></div></pre></table></figure><p>Do a quick build to pull our dependencies down:<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cargo build</div><div class="line">    Updating registry `https://github.com/rust-lang/crates.io-index`</div><div class="line"> Downloading rocket_codegen v0.1.4</div><div class="line"> Downloading rocket v0.1.4</div><div class="line"> Downloading num_cpus v1.2.1</div><div class="line"> Downloading libc v0.2.19</div><div class="line">   Compiling libc v0.2.19</div><div class="line">   Compiling typeable v0.1.2</div><div class="line">   Compiling traitobject v0.0.1</div><div class="line">   Compiling language-tags v0.2.2</div><div class="line">   Compiling unicode-normalization v0.1.3</div><div class="line">   Compiling winapi v0.2.8</div><div class="line">   Compiling rustc-serialize v0.3.22</div><div class="line">   Compiling ansi_term v0.9.0</div><div class="line">   Compiling httparse v1.2.1</div><div class="line">   Compiling log v0.3.6</div><div class="line">   Compiling mime v0.2.2</div><div class="line">   Compiling hpack v0.2.0</div><div class="line">   Compiling rocket_codegen v0.1.4</div><div class="line">error[E0554]: #[feature] may not be used on the stable release channel</div><div class="line"> --> /Users/shane.logsdon/.cargo/registry/src/github.com-1ecc6299db9ec823/rocket_codegen-0.1.4/build.rs:1:1</div><div class="line">  |</div><div class="line">1 | #![feature(slice_patterns)]</div><div class="line">  | ^^^^^^^^^^^^^^^^^^^^^^^^^^^</div><div class="line"></div><div class="line">error: aborting due to previous error</div><div class="line"></div><div class="line">Build failed, waiting for other jobs to finish...</div><div class="line">error: Could not compile `rocket_codegen`.</div><div class="line"></div><div class="line">To learn more, run the command again with --verbose.</div></pre></table></figure><p>That’s right. <code>rocket_codegen</code> requires some Rust nightly features at the moment, so lets use <code>rustup</code> to override our current Rust toolchain:<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ rustup override set nightly</div><div class="line">info: using existing install for 'nightly-x86_64-apple-darwin'</div><div class="line">info: override toolchain for '/Users/shane.logsdon/Code/rust/rocket_testing' set to 'nightly-x86_64-apple-darwin'</div><div class="line"></div><div class="line">  nightly-x86_64-apple-darwin unchanged - rustc 1.15.0-nightly (71c06a56a 2016-12-18)</div><div class="line"></div><div class="line">$ cargo build</div></pre></table></figure><p>That time should do it if you’re using a nightly release for the first time, but if your’ve already had a nightly installed, you may run into this issue:<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Build failed, waiting for other jobs to finish...</div><div class="line">error: failed to run custom build command for `rocket_codegen v0.1.4`</div><div class="line">process didn't exit successfully: `/Users/shane.logsdon/Code/rust/rt/target/debug/build/rocket_codegen-0930e5f9972e7ac3/build-script-build` (exit code: 101)</div><div class="line">--- stderr</div><div class="line">Error: Rocket codegen requires a newer version of rustc.</div><div class="line">Use `rustup update` or your preferred method to update Rust.</div><div class="line">Installed version is: 2016-12-18. Minimum required: 2017-01-03.</div><div class="line">thread 'main' panicked at 'Aborting compilation due to incompatible compiler.', /Users/shane.logsdon/.cargo/registry/src/github.com-1ecc6299db9ec823/rocket_codegen-0.1.4/build.rs:62</div><div class="line">note: Run with `RUST_BACKTRACE=1` for a backtrace.</div></pre></table></figure><p>We’re told that our installed version of Rust nightly is too old, and we need to install a newer one. Luckily, it’s a couple of quick commands to fix:<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ rustup update && cargo update && cargo build</div><div class="line"># ... eventually seeing</div><div class="line">Finished debug [unoptimized + debuginfo] target(s) in 36.35 secs</div></pre></table></figure><p>Once our initial build completes, we’ll want to update our application code in <code>src/main.rs</code> to leverage Rocket:<figure class="highlight rust"><table><tr><td class="code"><pre><div class="line"><span class="meta">#![feature(plugin)]</span></div><div class="line"><span class="meta">#![plugin(rocket_codegen)]</span></div><div class="line"></div><div class="line"><span class="keyword">extern</span> <span class="keyword">crate</span> rocket;</div><div class="line"></div><div class="line"><span class="meta">#[get(<span class="meta-string">"/text"</span>)]</span></div><div class="line"><span class="function"><span class="keyword">fn</span> <span class="title">hello</span></span>() -> <span class="built_in">String</span> {</div><div class="line">    <span class="built_in">String</span>::from_str(<span class="string">"hello world"</span>)</div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() {</div><div class="line">    rocket::ignite()</div><div class="line">        .mount(<span class="string">"/"</span>, routes![hello])</div><div class="line">        .launch();</div><div class="line">}</div></pre></table></figure><p>We can then build again and test our application (Rocket listens on <a href="http://localhost:8000/"rel="external"target="_blank"><code>http://localhost:8000/</code></a> by default). At this point we have a working application for our host system, which in my case has the triple <code>x86_64-apple-darwin</code>.<h2 id="Where-do-we-find-our-target-build-toolchain"><a href="#Where-do-we-find-our-target-build-toolchain"class="headerlink"title="Where do we find our target build toolchain?"></a>Where do we find our target build toolchain?</h2><p>Since we now have a working application, we need to figure out how to get our application cross-compiled. Some googling resulted in some useful information specifically for Rust. <a href="https://github.com/japaric/rust-cross"rel="external"target="_blank"><code>rust-cross</code></a> has some excellent information on this process, but since I didn’t even know what the Omega2’s architecture was, I figured I better find out. I booted up my Omega2+ and <code>ssh</code>‘d into it:<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ ssh root@192.168.3.1</div><div class="line">root@192.168.3.1's password:</div><div class="line"></div><div class="line"></div><div class="line">BusyBox v1.25.1 () built-in shell (ash)</div><div class="line"></div><div class="line">   ____       _             ____</div><div class="line">  / __ \___  (_)__  ___    / __ \__ _  ___ ___ ____ _</div><div class="line"> / /_/ / _ \/ / _ \/ _ \  / /_/ /  ' \/ -_) _ `/ _ `/</div><div class="line"> \____/_//_/_/\___/_//_/  \____/_/_/_/\__/\_, /\_,_/</div><div class="line"> W H A T  W I L L  Y O U  I N V E N T ? /___/</div><div class="line"> -----------------------------------------------------</div><div class="line">   Ω-ware: 0.1.7 b139</div><div class="line"> -----------------------------------------------------</div><div class="line">root@Omega-708F:~# uname -a</div><div class="line">Linux Omega-708F 4.4.39 #0 Thu Dec 29 17:07:01 2016 mips GNU/Linux</div><div class="line">root@Omega-708F:~#</div></pre></table></figure><p>That told me enough to start my search for the reuired build chain. At this point, I went to <code>rustup</code> to see what architecture’s it supported.<blockquote><p>Side note: <code>rustup</code> not only manages Rust stable, beta, and nightly installations but also manages Rust toolchains for all the architectures Rust supports!</blockquote><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ rustup target list</div><div class="line">aarch64-apple-ios</div><div class="line">aarch64-linux-android</div><div class="line">aarch64-unknown-linux-gnu</div><div class="line">arm-linux-androideabi</div><div class="line">arm-unknown-linux-gnueabi</div><div class="line">arm-unknown-linux-gnueabihf</div><div class="line">arm-unknown-linux-musleabi</div><div class="line">arm-unknown-linux-musleabihf</div><div class="line">armv7-apple-ios</div><div class="line">armv7-linux-androideabi</div><div class="line">armv7-unknown-linux-gnueabihf</div><div class="line">armv7-unknown-linux-musleabihf</div><div class="line">armv7s-apple-ios</div><div class="line">asmjs-unknown-emscripten</div><div class="line">i386-apple-ios</div><div class="line">i586-pc-windows-msvc</div><div class="line">i586-unknown-linux-gnu</div><div class="line">i686-apple-darwin</div><div class="line">i686-linux-android</div><div class="line">i686-pc-windows-gnu</div><div class="line">i686-pc-windows-msvc</div><div class="line">i686-unknown-freebsd</div><div class="line">i686-unknown-linux-gnu</div><div class="line">i686-unknown-linux-musl</div><div class="line">mips-unknown-linux-gnu</div><div class="line">mips-unknown-linux-musl</div><div class="line">mips64-unknown-linux-gnuabi64</div><div class="line">mips64el-unknown-linux-gnuabi64</div><div class="line">mipsel-unknown-linux-gnu</div><div class="line">mipsel-unknown-linux-musl</div><div class="line">powerpc-unknown-linux-gnu</div><div class="line">powerpc64-unknown-linux-gnu</div><div class="line">powerpc64le-unknown-linux-gnu</div><div class="line">s390x-unknown-linux-gnu</div><div class="line">wasm32-unknown-emscripten</div><div class="line">x86_64-apple-darwin (default)</div><div class="line">x86_64-apple-ios</div><div class="line">x86_64-pc-windows-gnu</div><div class="line">x86_64-pc-windows-msvc</div><div class="line">x86_64-rumprun-netbsd</div><div class="line">x86_64-unknown-freebsd</div><div class="line">x86_64-unknown-linux-gnu</div><div class="line">x86_64-unknown-linux-musl</div><div class="line">x86_64-unknown-netbsd</div></pre></table></figure><p><code>rustup</code> is showing 6 <code>mips</code>-related targets. We’ve narrowed it down some, but we still don’t know the exact one we require or if Rust/<code>rustup</code> even support it. I took to looking through the <a href="https://community.onion.io/category/2/omega-talk"rel="external"target="_blank">community forums</a> searching for <code>mips</code> and began to see others looking to do some cross-compilation of code. Across a few separate thread, I put together some information:<ul><li>The Omega2’s use the MediaTek MT7688 SoC (system on chip) which include a MIPS® 24KEc™ CPU<li>The Omega2 OS is based on the <a href="https://lede-project.org/"rel="external"target="_blank">LEDE Project</a>, a fork of the OS behind OpenWrt<li>OpenWrt/LEDE have SDKs for building the OS firmware images which include the build toolchain</ul><p>Eventually, I found a few forum threads with references to <a href="https://github.com/WereCatf/source"rel="external"target="_blank">WereCatf’s repository</a>, a GitHub fork of the LEDE Project’s SDK with the necessary changes to add the Omega2 and Omega2+ build DTS (device tree source) configurations add a few other fixes. With the SDK, we have everything we need to build our application for the Omega2, but now the SDK needs to be built since we only have the source and nothing specific for the Omega2.<h2 id="Building-the-build-toolchain"><a href="#Building-the-build-toolchain"class="headerlink"title="Building the build toolchain"></a>Building the build toolchain</h2><p>Luckily, the build process for the LEDE SDK is the same as the OpenWrt SDK, and at least for MacOS, the build requirements are the same. I’ve included OpenWrt’s instructions for MacOS 10.11 here, but other versions and OS’s can be found on <a href="https://wiki.openwrt.org/doc/howto/buildroot.exigence.macosx"rel="external"target="_blank">their documentation site</a>.<blockquote><ol><li><p>Install Xcode or at least Xcode command line tools from the MacOSX App Store<li><p>Install <a href="http://brew.sh/"rel="external"target="_blank">Homebrew</a>.<li><p>Add duplicates repository to homebrew for grep formulae:<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">brew tap homebrew/dupes</div></pre></table></figure><li><p>Install additional formulae:<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">brew install coreutils findutils gawk gnu-getopt gnu-tar grep wget quilt xz</div></pre></table></figure><li><p><code>gnu-getopt</code> is keg-only, so force linking it:<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">brew ln gnu-getopt --force</div></pre></table></figure><li><p>To get rid of “date illegal option” you can add to your <code>.bash_profile</code> (wasn’t required for me):<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">PATH="/usr/local/opt/coreutils/libexec/gnubin:$PATH"</div></pre></table></figure><li><p>OS X by default comes with a case-insensitive filesystem. OpenWrt won’t build on that. As a workaround, create a (Sparse) case-sensitive disk-image that you then mount in Finder and use as build directory:<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">hdiutil create -size 20g -type SPARSE -fs "Case-sensitive HFS+" -volname OpenWrt OpenWrt.sparseimage</div><div class="line">hdiutil attach OpenWrt.sparseimage</div></pre></table></figure><li><p>Change to your newly created and mounted disk image:<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">/Volumes/OpenWrt</div></pre></table></figure><li><p>Now proceed normally (<code>git clone…</code>)</ol></blockquote><p>If, like me, you have no idea how to “proceed normally”, let me fill you in. We’re going to obtain the source, configure it for our needs, and build it.<h3 id="Getting-the-source"><a href="#Getting-the-source"class="headerlink"title="Getting the source"></a>Getting the source</h3><p>This one’s going to be quick and simple using <code>git</code>:<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ git clone https://github.com/WereCatf/source</div><div class="line">$ cd source</div></pre></table></figure><h3 id="Configuring-the-SDK"><a href="#Configuring-the-SDK"class="headerlink"title="Configuring the SDK"></a>Configuring the SDK</h3><p>Since OpenWrt/LEDE can be used on multiple architectures, we need to configure the SDK to be compatible with the Omega2. There are a few ways to do this, but we’ll use <code>make menuconfig</code> here for a <code>ncurses</code>-based configuration process.<blockquote><p>Tip: The menus use <code>up</code> and <code>down</code> keys to move between options, <code>left</code> and <code>right</code> to move between commands for a given screen (located at the bottom), <code>enter</code> to select a command (usually “Select”, “Exit”, and “Save”), and <code>space</code> to enable/select an option.</blockquote><p>The three items we need to set (with desired values) are:<ul><li>Target System: <code>MediaTek Ralink MIPS</code><li>Subtarget: <code>MT7688 based boards</code><li>Target Profile: <code>Onion Omega2</code> or <code>Onion Omega2+</code></ul><blockquote><p>Note: I also enabled the <code>Build the LEDE SDK</code> and <code>Package the LEDE-based Toolchain</code> options, but I have no idea if this affects the end result. They sounded important/useful. Having those enabled allowed for me to use the toolchain later, but I didn’t have the desire to go back to check if it was necessary.</blockquote><p>Don’t forget to save the configuration or else the SDK will build with its defaults.<h3 id="Build-the-toolchain"><a href="#Build-the-toolchain"class="headerlink"title="Build the toolchain"></a>Build the toolchain</h3><p>Building the SDK’s toolchain is another easy and simple process, but it takes some time to complete.<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ make toolchain/install</div></pre></table></figure><p>Let your system do its thing for a while, and do something enjoyable. You can also wait, wait, wait, wait. The good news to take away here is that this only needs to be done once per architecture for your build environment, so if you only use this SDK for the Omega2, it will only need to be built again if you want the build toolchain on another system Docker, etc. Eventually, it should finish, leaving your toolchain within the SDK directory:<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ tree -L 1 staging_dir/toolchain-mipsel_24kc_gcc-5.4.0_musl-1.1.15</div><div class="line">staging_dir/toolchain-mipsel_24kc_gcc-5.4.0_musl-1.1.15</div><div class="line">├── bin</div><div class="line">├── include</div><div class="line">├── info.mk</div><div class="line">├── initial</div><div class="line">├── lib</div><div class="line">├── lib32 -> lib</div><div class="line">├── lib64 -> lib</div><div class="line">├── libexec</div><div class="line">├── mipsel-openwrt-linux -> mipsel-openwrt-linux-musl</div><div class="line">├── mipsel-openwrt-linux-musl</div><div class="line">├── share</div><div class="line">├── stamp</div><div class="line">└── usr</div><div class="line"></div><div class="line">12 directories, 1 file</div></pre></table></figure><p>Cool. From <code>rustup</code>‘s possible <code>mips</code> targets (pasted below), we may be able to choose one finally:<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">mips-unknown-linux-gnu</div><div class="line">mips-unknown-linux-musl</div><div class="line">mips64-unknown-linux-gnuabi64</div><div class="line">mips64el-unknown-linux-gnuabi64</div><div class="line">mipsel-unknown-linux-gnu</div><div class="line">mipsel-unknown-linux-musl</div></pre></table></figure><p>Our toolchain seems to be for the <code>mipsel</code> architecture and is compatible with <code>musl</code>, a <code>libc</code> compatible library for compiling statically-linked applications, so the <code>mipsel-unknown-linux-musl</code> Rust toolchain could work for us. Attempting to run <code>cargo compile</code> at this point will result in a big wall of text and the following error:<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cd project/directory</div><div class="line">$ rustup target add mipsel-unknown-linux-musl</div><div class="line">$ cargo build --target mipsel-unknown-linux-musl</div><div class="line">$ ... big wall of text</div><div class="line">ld: unknown option: --as-needed</div><div class="line">clang: error: linker command failed with exit code 1 (use -v to see invocation)</div><div class="line"></div><div class="line"></div><div class="line">error: aborting due to previous error</div><div class="line"></div><div class="line">error: Could not compile `rocket_testing`.</div></pre></table></figure><p>This is due to my host system’s linker (<code>/usr/bin/cc</code>) being used during the build but being incompatible with the <code>mipsel</code> architecture. Being completely new to cross-compilation, I had no idea how to use the correct build toolchain. Luckily, Rust ecosystem developers love documentation, and Cargo’s documentation includes a page on <a href="http://doc.crates.io/config.html"rel="external"target="_blank">configuration</a> that gave me a hint in the <code>target.$triple.linker</code> configuration key:<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">[target.mipsel-unknown-linux-musl]</div><div class="line">linker = "/Volumes/OpenWrt/lede/staging_dir/toolchain-mipsel_24kc_gcc-5.4.0_musl-1.1.15/bin/mipsel-openwrt-linux-musl-gcc"</div></pre></table></figure><p>Adding that to my <code>Cargo.toml</code> file … didn’t help. Turns out that target configuration options are ignored in a project’s <code>Cargo.toml</code> and need to be in a <code>.cargo/config</code> (also covered by the Cargo documentation page on configuration). The resulting directory structure with the added <code>.cargo/config</code> file:<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ tree -a -L 2</div><div class="line">.</div><div class="line">├── .cargo</div><div class="line">│   └── config</div><div class="line">├── .gitignore</div><div class="line">├── Cargo.lock</div><div class="line">├── Cargo.toml</div><div class="line">├── src</div><div class="line">│   └── main.rs</div><div class="line">└── target</div><div class="line">    ├── debug</div><div class="line">    ├── mipsel-unknown-linux-musl</div><div class="line">    └── release</div><div class="line"></div><div class="line">6 directories, 5 files</div></pre></table></figure><p>Running <code>cargo build</code> again bears some results:<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cargo build --target=mipsel-unknown-linux-musl</div><div class="line">   Compiling rocket_testing v0.1.0 (file:///Users/shane.logsdon/Code/rust/rocket-testing)</div><div class="line">    Finished debug [unoptimized + debuginfo] target(s) in 2.27 secs</div></pre></table></figure><p>It’s built, but does it run? Let’s ship it over to the Omega2+ to test:<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cargo build --target=mipsel-unknown-linux-musl --release</div><div class="line"># ... build log</div><div class="line">    Finished release [optimized] target(s) in 305.51 secs</div><div class="line">$ scp target/mipsel-unknown-linux-musl/release/rocket_testing root@192.168.3.1:/root/</div><div class="line">rocket_testing                                        100%   17MB  93.1KB/s   03:04</div></pre></table></figure><p>That uploaded the application’s release binary to the root user’s <code>$HOME</code> directory and can be ran with <code>cd /root && ./rocket_testing</code>:<p><blockquote class="twitter-tweet"data-conversation="none"data-lang="en"><br><p dir="ltr"lang="en"><br>running <a href="https://t.co/3I3pE2WS4W"rel="external"target="_blank">https://t.co/3I3pE2WS4W</a><br>and <a href="https://twitter.com/rustlang"rel="external"target="_blank">@rustlang</a> on an<br><a href="https://twitter.com/OnionIoT"rel="external"target="_blank">@OnionIoT</a> Omega 2+, cross-compiled from MacOS<br><a href="https://t.co/SdiKSNPZMZ"rel="external"target="_blank">pic.twitter.com/SdiKSNPZMZ</a><br></p><br>— Shane Logsdon (@shanelogsdon)<br><a href="https://twitter.com/shanelogsdon/status/819204972290199553"rel="external"target="_blank">January 11, 2017</a><br></blockquote></p><script async charset="utf-8"src="//platform.twitter.com/widgets.js"></script><h2 id="Departing-notes"><a href="#Departing-notes"class="headerlink"title="Departing notes"></a>Departing notes</h2><p>I don’t believe this is perfect, but it will get the majority of applications compiled for the Omega2. I’ve already ran into an issue when using <a href="http://diesel.rs"rel="external"target="_blank">Diesel</a> and Postgres in a project, but I feel like it only needs some tweaking to get it going. This post will be updated once I figure that bit out.<p>The Omega2 isn’t the only build target available for Rust, as shown by <code>rustup target list</code>, and is accompanied by <code>arm</code> (e.g. Raspberry Pi Zero), <code>armv7</code> (e.g. Raspberry Pi 2 Model B), and <code>wasm32</code> (WebAssembly, currently available in Chrome Canary and Firefox Nightly). Cross-compilation could allow you to target all these platforms with the same code base, useful if you’re building an Internet of Things <a href="http://www.welivesecurity.com/2016/10/24/10-things-know-october-21-iot-ddos-attacks/"rel="external"target="_blank"><del>botnet</del></a> application and want to use multiple device types, or it could allow you to ship compiled binaries for your customers’s various production environments using a single build environment configuration.</p><script>var classes={".content a":["black-70"],".content p, .content ul, .content ol":["measure"],".post .content > p:first-of-type":["f4"],".content blockquote":["ml3","pl3","bl","b--black-10","bw4"]};for(var selector in classes)if(classes.hasOwnProperty(selector)){var contents=document.querySelectorAll(selector);Array.prototype.slice.call(contents).map(function(t){classes[selector].map(function(e){t.classList.add(e)})})}</script></section><footer class="b--black-10 bt bb mt4 post-footer"><p class="meta tags"><span class="label">tags:</span> <a href=""class="black-70 ml3">rust</a> <a href=""class="black-70 ml3">hardware</a></footer></article></main><footer class="mv4 footer db-l dn"><p class="dib mr3 copyright"><small>© 2017 Shane Logsdon</small><p class="dib mr3 rss-subscribe"><small>subscribe <a href="/feed.xml"class="black-70">via RSS</a></small><p class="dib mr3 toggle-ligatures"><small><a href="javascript:toggleLigatures();"class="black-70">toggle code ligatures</a></small><script>function toggleLigatures(){return-1===document.body.className.indexOf("fira-code")?void(document.body.className+=" fira-code"):void(document.body.className=document.body.className.replace(" fira-code",""))}</script></footer></div><header class="b--black-10 bt bn-l dib-ns f6 fl-l header lh-copy ml3-l mt1-l mt3 tc v-top-ns w-100 w-20-l"><div class="mv4 mv5-l"><a href="/"class="black-70 b f3-l f4"title="Home"id="menu">Shane Logsdon<div><small class="f6 normal">Polyglot Developer</small></div></a></div><nav class="b--black-10 bt bb mv4 mv5-l page-nav"><ul class="list pl1"><li class="di"><a href="/"class="black-70 mr3 page-link">Home</a><li class="di"><a href="/posts/"class="black-70 mr3 page-link">Posts</a><li class="di"><a href="/projects/"class="black-70 mr3 page-link">Projects</a><li class="di"><a href="/presentations/"class="black-70 mr3 page-link">Presentations</a><li class="di"><a href="/about/"class="black-70 mr3 page-link">About</a></ul></nav><p class="mv4-l description ma3">I develop things. Sometimes, I write about them here. Let's start a conversation.<nav class="mv3 interaction-nav pb3"><ul class="list contact-list tl"><li class="mv1">Email me: <a href="mailto:shane@logsdon.io"class="black-70"rel="noopener"target="_blank">shane@logsdon.io</a><li class="mv1">Develop with me: <a href="https://github.com/slogsdon"class="black-70"title="GitHub"rel="noopener"target="_blank">slogsdon</a><li class="mv1">Tweet me: <a href="https://twitter.com/shanelogsdon"class="black-70"title="Twitter"rel="noopener"target="_blank">shanelogsdon</a></ul></nav><nav class="mv3 mv4-l tag-nav">Tags<ul class="list tag-list tj"><li class="dib ma1"><a href="/tag/net/"class="black-70">.net</a><li class="dib ma1"><a href="/tag/acvte/"class="black-70">acvte</a><li class="dib ma1"><a href="/tag/apache/"class="black-70">apache</a><li class="dib ma1"><a href="/tag/api/"class="black-70">api</a><li class="dib ma1"><a href="/tag/authentication/"class="black-70">authentication</a><li class="dib ma1"><a href="/tag/azure/"class="black-70">azure</a><li class="dib ma1"><a href="/tag/bcrypt/"class="black-70">bcrypt</a><li class="dib ma1"><a href="/tag/chicagoboss/"class="black-70">chicagoboss</a><li class="dib ma1"><a href="/tag/csharp/"class="black-70">csharp</a><li class="dib ma1"><a href="/tag/deployment/"class="black-70">deployment</a><li class="dib ma1"><a href="/tag/devops/"class="black-70">devops</a><li class="dib ma1"><a href="/tag/docker/"class="black-70">docker</a><li class="dib ma1"><a href="/tag/elixir/"class="black-70">elixir</a><li class="dib ma1"><a href="/tag/erlang/"class="black-70">erlang</a><li class="dib ma1"><a href="/tag/exrm/"class="black-70">exrm</a><li class="dib ma1"><a href="/tag/fsharp/"class="black-70">fsharp</a><li class="dib ma1"><a href="/tag/functional-programming/"class="black-70">functional programming</a><li class="dib ma1"><a href="/tag/genevent/"class="black-70">genevent</a><li class="dib ma1"><a href="/tag/golang/"class="black-70">golang</a><li class="dib ma1"><a href="/tag/hardware/"class="black-70">hardware</a><li class="dib ma1"><a href="/tag/haskell/"class="black-70">haskell</a><li class="dib ma1"><a href="/tag/homebrew/"class="black-70">homebrew</a><li class="dib ma1"><a href="/tag/http/"class="black-70">http</a><li class="dib ma1"><a href="/tag/javascript/"class="black-70">javascript</a><li class="dib ma1"><a href="/tag/linux/"class="black-70">linux</a><li class="dib ma1"><a href="/tag/mandrill/"class="black-70">mandrill</a><li class="dib ma1"><a href="/tag/migration/"class="black-70">migration</a><li class="dib ma1"><a href="/tag/mysql/"class="black-70">mysql</a><li class="dib ma1"><a href="/tag/nginx/"class="black-70">nginx</a><li class="dib ma1"><a href="/tag/obtvse2/"class="black-70">obtvse2</a><li class="dib ma1"><a href="/tag/payments/"class="black-70">payments</a><li class="dib ma1"><a href="/tag/percona/"class="black-70">percona</a><li class="dib ma1"><a href="/tag/phalcon/"class="black-70">phalcon</a><li class="dib ma1"><a href="/tag/php/"class="black-70">php</a><li class="dib ma1"><a href="/tag/rails/"class="black-70">rails</a><li class="dib ma1"><a href="/tag/redirects/"class="black-70">redirects</a><li class="dib ma1"><a href="/tag/review/"class="black-70">review</a><li class="dib ma1"><a href="/tag/ruby/"class="black-70">ruby</a><li class="dib ma1"><a href="/tag/rust/"class="black-70">rust</a><li class="dib ma1"><a href="/tag/sockets/"class="black-70">sockets</a><li class="dib ma1"><a href="/tag/talk/"class="black-70">talk</a><li class="dib ma1"><a href="/tag/testing/"class="black-70">testing</a><li class="dib ma1"><a href="/tag/vagrant/"class="black-70">vagrant</a><li class="dib ma1"><a href="/tag/wordpress/"class="black-70">wordpress</a><li class="dib ma1"><a href="/tag/workshop/"class="black-70">workshop</a></ul></nav></header><footer class="mv4 footer db dn-l"><p class="dib mr3 copyright"><small>© 2017 Shane Logsdon</small><p class="dib mr3 rss-subscribe"><small>subscribe <a href="/feed.xml"class="black-70">via RSS</a></small><p class="dib mr3 toggle-ligatures"><small><a href="javascript:toggleLigatures();"class="black-70">toggle code ligatures</a></small><script>function toggleLigatures(){return-1===document.body.className.indexOf("fira-code")?void(document.body.className+=" fira-code"):void(document.body.className=document.body.className.replace(" fira-code",""))}</script></footer><noscript id="deferred-styles"><link href="/assets/css/main.css"rel="stylesheet"media="all"></noscript><script>var loadDeferredStyles=function(){var e=document.getElementById("deferred-styles"),t=document.createElement("div");t.innerHTML=e.textContent,document.body.appendChild(t),e.parentElement.removeChild(e)},raf=requestAnimationFrame||mozRequestAnimationFrame||webkitRequestAnimationFrame||msRequestAnimationFrame;raf?raf(function(){window.setTimeout(loadDeferredStyles,0)}):window.addEventListener("load",loadDeferredStyles)</script>